# =============================================================================
# Biomedical AI-Q Research Agent CI
# =============================================================================
#
# Required Secrets:
#   - NGC_API_KEY          : NVIDIA NGC API Key for container registry access
#   - NVIDIA_API_KEY       : NVIDIA API Key for hosted NIM services
#   - TAVILY_API_KEY       : (Optional) Tavily API Key for web search
#   - SMTP_USERNAME        : Gmail address for sending notification emails
#   - SMTP_PASSWORD        : Gmail app-specific password for SMTP
#
# pytest markers:
#   - biomedical_aiq and (notebook or ui)
#
# -----------------------------------------------------------------------------
# Notebook → HTML Mapping (for pytest)
# -----------------------------------------------------------------------------
# The pytest test cases expect specific HTML filename in /app/input/
#
# | Notebook                                | Expected HTML filename                     |
# |-----------------------------------------|--------------------------------------------|
# | notebooks/get_started_nvidia_api.ipynb  | biomedical_get_started_nvidia_api.html     |
#
# =============================================================================

name: Biomedical AI-Q Research Agent CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  TEST_IMAGE: nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest
  QA_TESTER_REPO: https://github.com/bp-cicd-org/qa-tester.git
  RAG_VERSION: v2.2.1
  ENABLE_EMAIL_NOTIFICATION: false  # Set to false to disable email notifications

jobs:
  # ============================================
  # PREFLIGHT: Check all prerequisites
  # ============================================
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    outputs:
      preflight_passed: ${{ steps.preflight.outputs.passed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Preflight Checks
        id: preflight
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        run: |
          echo "========================================"
          echo "  PREFLIGHT CHECKS"
          echo "========================================"
          echo ""
          
          FAILED=0
          
          # Check 1: NGC API Key
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 1/6] NGC API Key                      │"
          echo "└──────────────────────────────────────────────┘"
          if [ -z "${NGC_API_KEY}" ]; then
            echo "✗ ERROR: NGC_API_KEY is not set"
            FAILED=1
          else
            echo "✓ NGC_API_KEY is set"
          fi
          echo ""
          
          # Check 2: NVIDIA API Key
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 2/6] NVIDIA API Key                   │"
          echo "└──────────────────────────────────────────────┘"
          if [ -z "${NVIDIA_API_KEY}" ]; then
            echo "✗ ERROR: NVIDIA_API_KEY is not set"
            FAILED=1
          else
            echo "✓ NVIDIA_API_KEY is set"
          fi
          echo ""
          
          # Check 3: Test Image can be pulled
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 3/6] Test Image                       │"
          echo "└──────────────────────────────────────────────┘"
          echo "Pulling test image: ${{ env.TEST_IMAGE }}"
          if docker pull ${{ env.TEST_IMAGE }}; then
            echo "✓ Test image pulled successfully"
          else
            echo "✗ ERROR: Cannot pull test image"
            FAILED=1
          fi
          echo ""
          
          # Check 4: Required notebook exists
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 4/6] Required Notebook                │"
          echo "└──────────────────────────────────────────────┘"
          if [ -f "notebooks/get_started_nvidia_api.ipynb" ]; then
            echo "✓ notebooks/get_started_nvidia_api.ipynb exists"
          else
            echo "✗ ERROR: notebooks/get_started_nvidia_api.ipynb not found"
            FAILED=1
          fi
          echo ""
          
          # Check 5: Docker Compose files
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 5/6] Docker Compose Files             │"
          echo "└──────────────────────────────────────────────┘"
          if [ -f "deploy/compose/docker-compose.yaml" ]; then
            echo "✓ deploy/compose/docker-compose.yaml exists"
          else
            echo "⚠ WARNING: deploy/compose/docker-compose.yaml not found"
          fi
          echo ""
          
          # Check 6: Clone qa-tester repository
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 6/6] QA Tester Repository             │"
          echo "└──────────────────────────────────────────────┘"
          echo "Cloning qa-tester repository..."
          if git clone --depth 1 https://x-access-token:${{ github.token }}@github.com/bp-cicd-org/qa-tester.git _qa_tester; then
            if [ -f "_qa_tester/utils/notebook_runner/notebook_runner_nbclient.py" ]; then
              echo "✓ qa-tester cloned and notebook_runner_nbclient.py found"
            else
              echo "✗ ERROR: notebook_runner_nbclient.py not found in qa-tester"
              FAILED=1
            fi
          else
            echo "✗ ERROR: Cannot clone qa-tester repository"
            FAILED=1
          fi
          echo ""
          
          # Final result
          echo "========================================"
          if [ $FAILED -eq 0 ]; then
            echo "✓ ALL PREFLIGHT CHECKS PASSED"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "✗ PREFLIGHT CHECKS FAILED"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "========================================"

  # ============================================
  # BIOMEDICAL AI-Q: Deploy & Test
  # ============================================
  biomedical-aiq:
    name: Biomedical AI-Q - Deploy & Test
    needs: preflight
    if: ${{ needs.preflight.outputs.preflight_passed == 'true' }}
    runs-on: arc-runner-set-oke-org-poc-4-gpu
    # runs-on: arc-runners-org-nvidia-ai-bp-4-gpu
    timeout-minutes: 240
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================
      # PHASE 1: Environment Setup
      # ==========================================
      - name: Setup Environment
        run: |
          echo "========================================"
          echo "  BIOMEDICAL AI-Q - ENVIRONMENT SETUP"
          echo "========================================"
          
          # System info
          echo "Runner: $(hostname)"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "Docker: $(docker --version)"
          echo ""
          
          # GPU info
          echo "GPU Information:"
          nvidia-smi --query-gpu=index,name,memory.total --format=csv,noheader || echo "nvidia-smi not available"
          echo ""

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Pull Test Image
        run: |
          echo "Pulling test image: ${{ env.TEST_IMAGE }}"
          docker pull ${{ env.TEST_IMAGE }}
          echo "✓ Test image pulled successfully"

      # ==========================================
      # PHASE 2: Setup Notebook Runner
      # ==========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download Notebook Runner
        run: |
          echo "Cloning qa-tester repository..."
          git clone --depth 1 https://x-access-token:${{ github.token }}@github.com/bp-cicd-org/qa-tester.git _qa_tester
          cp _qa_tester/utils/notebook_runner/notebook_runner_nbclient.py .
          rm -rf _qa_tester
          chmod +x notebook_runner_nbclient.py
          echo "✓ notebook_runner_nbclient.py ready"

      - name: Install Notebook Dependencies
        run: |
          pip install --upgrade pip
          pip install ipykernel nbclient nbformat jupyter nbconvert
          python -m ipykernel install --user --name python3 --display-name "Python 3"
          echo "✓ Notebook dependencies installed"

      # ==========================================
      # PHASE 3: Pre-configure Environment
      # ==========================================
      - name: Pre-configure Environment Variables
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          # Set environment variables for hosted NIM mode
          echo "USERID=$(id -u)" >> $GITHUB_ENV
          echo "NVIDIA_API_KEY=${NVIDIA_API_KEY}" >> $GITHUB_ENV
          echo "NGC_API_KEY=${NGC_API_KEY}" >> $GITHUB_ENV
          echo "TAVILY_API_KEY=${TAVILY_API_KEY}" >> $GITHUB_ENV
          
          # Hosted NIM endpoints
          echo "APP_LLM_MODELNAME=nvidia/llama-3.3-nemotron-super-49b-v1" >> $GITHUB_ENV
          echo "APP_EMBEDDINGS_MODELNAME=nvidia/llama-3.2-nv-embedqa-1b-v2" >> $GITHUB_ENV
          echo "APP_RANKING_MODELNAME=nvidia/llama-3.2-nv-rerankqa-1b-v2" >> $GITHUB_ENV
          echo "AIRA_HOSTED_NIMS=true" >> $GITHUB_ENV
          echo "MOLMIM_ENDPOINT_URL=https://health.api.nvidia.com/v1/biology/nvidia/molmim/generate" >> $GITHUB_ENV
          echo "DIFFDOCK_ENDPOINT_URL=https://health.api.nvidia.com/v1/biology/mit/diffdock" >> $GITHUB_ENV
          
          echo "✓ Environment variables configured for hosted NIM mode"

      # ==========================================
      # PHASE 4: Execute Notebook (Deploy)
      # ==========================================
      - name: Preprocess Notebook - Replace API Key Placeholders
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        run: |
          echo "Replacing API key placeholders in notebook..."
          # Replace hardcoded placeholder with actual API key value
          sed -i "s|nvapi-your-api-key|${NVIDIA_API_KEY}|g" notebooks/get_started_nvidia_api.ipynb
          echo "✓ Notebook preprocessed"

      - name: Execute Notebook - Deploy Biomedical AI-Q
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          echo "========================================"
          echo "  EXECUTING NOTEBOOK: get_started_nvidia_api"
          echo "========================================"
          
          # Export environment variables for notebook execution
          export NVIDIA_API_KEY="${NVIDIA_API_KEY}"
          export NGC_API_KEY="${NGC_API_KEY}"
          export TAVILY_API_KEY="${TAVILY_API_KEY}"
          
          COMMIT_SHA=$(git rev-parse --short=7 HEAD)
          
          python notebook_runner_nbclient.py \
            -f notebooks/get_started_nvidia_api.ipynb \
            --output-dir notebook_output \
            --timeout 3600 \
            --skip-deps-check \
            --skip-tags ci-skip \
            -e NGC_API_KEY="${NGC_API_KEY}" \
            -e NVIDIA_API_KEY="${NVIDIA_API_KEY}" \
            -e TAVILY_API_KEY="${TAVILY_API_KEY}"
          
          echo ""
          echo "✓ Notebook execution completed"
          echo "Generated files:"
          ls -la notebook_output/

      - name: Wait for Services Ready
        run: |
          echo "========================================"
          echo "  WAITING FOR SERVICES TO BE READY"
          echo "========================================"
          
          MAX_ATTEMPTS=120
          ATTEMPT=0
          
          # Wait for Frontend (port 3001)
          echo "Checking Frontend service (http://localhost:3001)..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -sf -o /dev/null http://localhost:3001 2>/dev/null; then
              echo "✓ Frontend is ready (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  Waiting... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          # Wait for Backend (port 8051)
          ATTEMPT=0
          echo "Checking Backend service (http://localhost:8051/docs)..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -sf -o /dev/null http://localhost:8051/docs 2>/dev/null; then
              echo "✓ Backend is ready (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  Waiting... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "⚠ WARNING: Some services timeout, but continuing..."
          fi
          
          # Show container status
          echo ""
          echo "Docker containers status:"
          docker ps -a --format "table {{.Names}}\t{{.Status}}"
          
          # Debug: Check for failed containers and show their logs
          echo ""
          echo "========================================"
          echo "  DEBUG: Checking for failed containers"
          echo "========================================"
          
          FAILED_CONTAINERS=$(docker ps -a --filter "status=exited" --format "{{.Names}}")
          if [ -n "$FAILED_CONTAINERS" ]; then
            echo "⚠ Found exited containers:"
            for container in $FAILED_CONTAINERS; do
              echo ""
              echo "----------------------------------------"
              echo "Container: $container"
              echo "----------------------------------------"
              echo "Exit code: $(docker inspect $container --format='{{.State.ExitCode}}')"
              echo "Error: $(docker inspect $container --format='{{.State.Error}}')"
              echo ""
              echo "Last 50 lines of logs:"
              docker logs --tail 50 $container 2>&1 || echo "Failed to get logs"
              echo "----------------------------------------"
            done
          else
            echo "✓ No failed containers found"
          fi
          
          # Debug: Check unhealthy containers
          UNHEALTHY_CONTAINERS=$(docker ps -a --filter "health=unhealthy" --format "{{.Names}}")
          if [ -n "$UNHEALTHY_CONTAINERS" ]; then
            echo ""
            echo "⚠ Found unhealthy containers:"
            for container in $UNHEALTHY_CONTAINERS; do
              echo ""
              echo "Container: $container"
              echo "Health status: $(docker inspect $container --format='{{.State.Health.Status}}')"
              echo "Last health check: $(docker inspect $container --format='{{range .State.Health.Log}}{{.Output}}{{end}}' | tail -5)"
            done
          fi

      # ==========================================
      # PHASE 5: Prepare HTML and Run pytest
      # ==========================================
      - name: Prepare HTML for pytest
        run: |
          mkdir -p notebook_output
          
          # Copy notebook HTML output with expected name for tests
          NOTEBOOK_HTML=$(ls notebook_output/*.html 2>/dev/null | head -1)
          if [ -n "$NOTEBOOK_HTML" ]; then
            cp "$NOTEBOOK_HTML" notebook_output/biomedical_get_started_nvidia_api.html
            echo "✓ Notebook HTML prepared: $NOTEBOOK_HTML -> biomedical_get_started_nvidia_api.html"
          fi
          
          ls -la notebook_output/

      - name: Run Tests
        id: pytest
        run: |
          echo "========================================"
          echo "  RUNNING PYTEST: biomedical_aiq (notebook + ui)"
          echo "========================================"
          
          COMMIT_SHA=$(git rev-parse --short=7 HEAD)
          REPORT_FILE="biomedical_aiq_${COMMIT_SHA}_test_report.html"
          
          mkdir -p test_reports
          
          # Run pytest with test image (services are running on this same runner)
          # Deselect T5169508: UI test with 10s timeout too short for hosted NIM LLM response
          docker run --rm \
            --network host \
            -v "$(pwd)/notebook_output:/app/input" \
            -v "$(pwd)/test_reports:/app/reports" \
            ${{ env.TEST_IMAGE }} \
            pytest -m "biomedical_aiq and (notebook or ui)" \
              -k "not T5169508" \
              --playground-url="http://localhost:3001" \
              --api-url="http://localhost:8051" \
              --disable-warnings \
              --self-contained-html \
              --html=/app/reports/${REPORT_FILE}
          
          echo ""
          echo "Test report saved to: test_reports/${REPORT_FILE}"

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: biomedical-aiq-test-report
          path: test_reports/
          retention-days: 30

      - name: Upload Notebook HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: biomedical-aiq-notebook-html
          path: notebook_output/*.html
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping all containers..."
          docker compose -f deploy/compose/docker-compose.yaml --profile aira down 2>/dev/null || true
          docker compose -f rag/deploy/compose/docker-compose-rag-server.yaml down 2>/dev/null || true
          docker compose -f rag/deploy/compose/docker-compose-ingestor-server.yaml down 2>/dev/null || true
          docker compose -f rag/deploy/compose/vectordb.yaml down 2>/dev/null || true
          docker stop $(docker ps -aq) 2>/dev/null || true
          echo "✓ Cleanup completed"

  # ============================================
  # SUMMARY: Generate final report
  # ============================================
  summary:
    name: Generate Summary
    needs: [preflight, biomedical-aiq]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Generate Summary Report
        run: |
          echo "# Biomedical AI-Q Research Agent CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Preflight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy & Test | ${{ needs.biomedical-aiq.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Notebook**: \`notebooks/get_started_nvidia_api.ipynb\`" >> $GITHUB_STEP_SUMMARY
          echo "- **pytest markers**: \`biomedical_aiq and (notebook or ui)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **RAG Version**: ${{ env.RAG_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test reports and notebook HTML outputs are available in the Artifacts section." >> $GITHUB_STEP_SUMMARY
          
          if [ -d "artifacts" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Downloaded Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find artifacts -type f -name "*.html" 2>/dev/null || echo "No HTML files found"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set Result Output
        id: set_result
        if: always()
        run: |
          # Check if all required jobs passed
          if [ "${{ needs.preflight.result }}" == "success" ] && \
             [ "${{ needs.biomedical-aiq.result }}" == "success" ]; then
            echo "RESULT=PASS" >> $GITHUB_OUTPUT
          else
            echo "RESULT=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@6e71c855c9a091d80a519621b9fd3e8d252ca40c
        if: always() && env.ENABLE_EMAIL_NOTIFICATION == 'true'
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI Result: Biomedical AI-Q Research Agent - ${{ steps.set_result.outputs.RESULT }}"
          to: Github-Action-Blueprint-QA@nvidia.com
          from: github-workflow-notification@gmail.com
          html_body: |
            <h2>Biomedical AI-Q Research Agent CI Notification</h2>
            
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
            <p><strong>Commit:</strong> ${{ github.sha }}</p>
            <p><strong>Result:</strong> <span style="color: ${{ steps.set_result.outputs.RESULT == 'PASS' && 'green' || 'red' }}; font-weight: bold;">${{ steps.set_result.outputs.RESULT }}</span></p>
            
            <h3>Job Results</h3>
            <table border="1" cellpadding="5" cellspacing="0">
              <tr><th>Job</th><th>Status</th></tr>
              <tr><td>Preflight</td><td>${{ needs.preflight.result }}</td></tr>
              <tr><td>Deploy & Test</td><td>${{ needs.biomedical-aiq.result }}</td></tr>
            </table>
            
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Run</a></p>
